-- Databricks notebook source
-- DBTITLE 1,Take a backup of original table
--drop table nfaprod_mo_axis.runinfo_backup;
create table nfaprod_mo_axis.runinfo_backup as select * from nfaprod_mo_axis.runinfo;
--insert into table nfaprod_mo_axis.runinfo values('1','26705b10-d8d4-11ea-afc7-00163e1361cf','2020-08-07T17:33:47.817+0000',644603456,'\\ACTLAXISMODELS\ACTL-AXISMODELSTEST\DEVWA\VALUATION\IFA\UNLOCK\20Q3\GAAP\DATASETS\NW_FIA_20Q1_V17_05_WAITTIME',38,'FI\04-VGAAP\01E___\Run SOP/DAC','2020-06-04T04:30:56.000+0000',20,'|User Values (Long)||User Value Long    1:                    1|User Value Long    2:                    1|User Value Long    3:                   20|User Value Long    4:                    1|User Value Long    5:                    0|User Value Long    6:                    2|User Value Long    7:                    0|User Value Long    8:                    1|User Value Long    9:                    1|User Value Long   10:                    0|User Value Long   11:                    0|User Value Long   12:                    1|User Value Long   13:                    1|User Value Long   14:                    0|User Value Long   15:                    0|User Value Long   16:                    0|User Value Long   17:                    0|User Value Long   18:                    1|User Value Long   19:                    0|User Value Long   20:                    0|User Value Long   21:                    0|User Value Long   22:                    0|User Value Long   23:                    0|User Value Long   24:                    0|User Value Long   25:                    0|User Value Long   26:                    0|User Value Long   27:                    0|User Value Long   28:                    0|User Value Long   29:                    0|User Value Long   30:                    0|User Value Long   31:                    0|User Value Long   32:                    0|User Value Long   33:                    0|User Value Long   34:                    0|User Value Long   35:                    0|User Value Long   36:                    0|User Value Long   37:                    0|User Value Long   38:                    0|User Value Long   39:                    0|User Value Long   40:                    0|User Value Long   41:                    0|User Value Long   42:                    0|User Value Long   43:                    0|User Value Long   44:                    0|User Value Long   45:                    0|User Value Long   46:                    0|User Value Long   47:                    0|User Value Long   48:                    0|User Value Long   49:                    0|User Value Long   50:                    0|User Value Long   51:                    0|User Value Long   52:                    0|User Value Long   53:                    0|User Value Long   54:                    0|User Value Long   55:                    0|User Value Long   56:                    0|User Value Long   57:                    0|User Value Long   58:                    0|User Value Long   59:                    0|User Value Long   60:                    0|User Value Long   61:                    0|User Value Long   62:                    0|User Value Long   63:                    0|User Value Long   64:                    0|User Value Long   65:                    0|User Value Long   66:                    0|User Value Long   67:                    0|User Value Long   68:                    0|User Value Long   69:                    0|User Value Long   70:                    0|User Value Long   71:                    0|User Value Long   72:                    0|User Value Long   73:                    0|User Value Long   74:                    0|User Value Long   75:                    0|User Value Long   76:                    0|User Value Long   77:                    0|User Value Long   78:                    0|User Value Long   79:                    0|User Value Long   80:                    0|User Value Long   81:                    0|User Value Long   82:                    0|User Value Long   83:                    0|User Value Long   84:                    0|User Value Long   85:                    0|User Value Long   86:                    0|User Value Long   87:                    0|User Value Long   88:                    0|User Value Long   89:                    0|User Value Long   90:                    0|User Value Long   91:                    0|User Value Long   92:                    0|User Value Long   93:                    0|User Value Long   94:                    0|User Value Long   95:                    0|User Value Long   96:                    0|User Value Long   97:                    0|User Value Long   98:                    0|User Value Long   99:                    0|User Value Long  100:                    0||User Values (Double)||User Value Double    1:           500.000000|User Value Double    2:             0.077500|User Value Double    3:             2.000000|User Value Double    4:             0.210000|User Value Double    5:             4.900000|User Value Double    6:             0.000000|User Value Double    7:             0.000000|User Value Double    8:             0.000000|User Value Double    9:             0.000000|User Value Double   10:             0.000000|User Value Double   11:             0.000000|User Value Double   12:             0.000000|User Value Double   13:             0.000000|User Value Double   14:             0.000000|User Value Double   15:             0.000000|User Value Double   16:             0.000000|User Value Double   17:             0.000000|User Value Double   18:             0.000000|User Value Double   19:             0.000000|User Value Double   20:             0.000000|User Value Double   21:             0.000000|User Value Double   22:             0.000000|User Value Double   23:             0.000000|User Value Double   24:             0.000000|User Value Double   25:             0.000000|User Value Double   26:             0.000000|User Value Double   27:             0.000000|User Value Double   28:             0.000000|User Value Double   29:             0.000000|User Value Double   30:             0.000000|User Value Double   31:             0.000000|User Value Double   32:             0.000000|User Value Double   33:             0.000000|User Value Double   34:             0.000000|User Value Double   35:             0.000000|User Value Double   36:             0.000000|User Value Double   37:             0.000000|User Value Double   38:             0.000000|User Value Double   39:             0.000000|User Value Double   40:             0.000000|User Value Double   41:             0.000000|User Value Double   42:             0.000000|User Value Double   43:             0.000000|User Value Double   44:             0.000000|User Value Double   45:             0.000000|User Value Double   46:             0.000000|User Value Double   47:             0.000000|User Value Double   48:             0.000000|User Value Double   49:             0.000000|User Value Double   50:             0.000000|User Value Double   51:             0.000000|User Value Double   52:             0.000000|User Value Double   53:             0.000000|User Value Double   54:             0.000000|User Value Double   55:             0.000000|User Value Double   56:             0.000000|User Value Double   57:             0.000000|User Value Double   58:             0.000000|User Value Double   59:             0.000000|User Value Double   60:             0.000000|User Value Double   61:             0.000000|User Value Double   62:             0.000000|User Value Double   63:             0.000000|User Value Double   64:             0.000000|User Value Double   65:             0.000000|User Value Double   66:             0.000000|User Value Double   67:             0.000000|User Value Double   68:             0.000000|User Value Double   69:             0.000000|User Value Double   70:             0.000000|User Value Double   71:             0.000000|User Value Double   72:             0.000000|User Value Double   73:             0.000000|User Value Double   74:             0.000000|User Value Double   75:             0.000000|User Value Double   76:             0.000000|User Value Double   77:             0.000000|User Value Double   78:             0.000000|User Value Double   79:             0.000000|User Value Double   80:             0.000000|User Value Double   81:             0.000000|User Value Double   82:             0.000000|User Value Double   83:             0.000000|User Value Double   84:             0.000000|User Value Double   85:             0.000000|User Value Double   86:             0.000000|User Value Double   87:             0.000000|User Value Double   88:             0.000000|User Value Double   89:             0.000000|User Value Double   90:             0.000000|User Value Double   91:             0.000000|User Value Double   92:             0.000000|User Value Double   93:             0.000000|User Value Double   94:             0.000000|User Value Double   95:             0.000000|User Value Double   96:             0.000000|User Value Double   97:             0.000000|User Value Double   98:             0.000000|User Value Double   99:             0.000000|User Value Double  100:             0.000000|',3,2020,'20201201','lanzd3');

-- COMMAND ----------

-- DBTITLE 1,Check's
describe nfaprod_mo_axis.runinfo;

-- COMMAND ----------

describe nfaprod_mo_axis.runinfo_backup;

-- COMMAND ----------

select count(*) from nfaprod_mo_axis.runinfo;

-- COMMAND ----------

select count(*) from nfaprod_mo_axis.runinfo_backup;

-- COMMAND ----------

select * from nfaprod_mo_axis.runinfo;

-- COMMAND ----------

select * from nfaprod_mo_axis.runinfo_backup;

-- COMMAND ----------

-- DBTITLE 1,Delete duplicate records
MERGE INTO nfaprod_mo_axis.runinfo o
USING (with mindate as (select 
DBSRowID,
RunID,
DBSRunTime,
max(DBSRunTime) over(partition by RunID) as maxDBSRunTime
from nfaprod_mo_axis.runinfo)
select DBSRowID from mindate where DBSRunTime=maxDBSRunTime) d
ON o.DBSRowID = d.DBSRowID
WHEN MATCHED THEN DELETE;

-- COMMAND ----------

-- DBTITLE 1,Final Check
select RunID, DatasetPathName, JobId, JobName, BatchStartTs, LineOfBusinessId, RunCommentText, ValuationMonthDate, ValuationYearDate, VersionNumber, UserName, count(*) 
from nfaprod_mo_axis.runinfo
group by RunID, DatasetPathName, JobId, JobName, BatchStartTs, LineOfBusinessId, RunCommentText, ValuationMonthDate, ValuationYearDate, VersionNumber, UserName
having count(*) > 1;
